<?xml version="1.0" encoding="UTF-8"?>
<modification>
   <id>Add cyclibg price3 feature depending on how many months the cycle is for. Multiply the price for the moths. Create the function that get the cyclibg payment fro the selected product and retinr it as int. </id>
   <version>1.0</version>
   <vqmver>2.X</vqmver>
   <author>Maadix.net - Maddish</author>
   <file name="system/library/cart/cart.php">
       <operation info="Add the function into the file">
           <search position="replace"><![CDATA[
             public function getProducts() {
           ]]></search>
           <add><![CDATA[
            public function getCyclingMonths($cart_id, $product_id){
                switch ($product_id){
                case 50:
                  $option_id= 232;
                  break;
                case 51:
                  $option_id= 233; 
                  break;
                case 52:
                  $option_id = 238;
                  break;
                case 53:
                  $option_id = 241;
                  break;
                default:
                  break;
                }

            $cart_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "cart WHERE api_id = '" . (isset($this->session->data['api_id']) ? (int)$this->session->data['api_id'] : 0) . "' AND customer_id = '" . (int)$this->customer->getId() . "' AND cart_id = '" . (int)$cart_id . "' AND session_id = '" . $this->db->escape($this->session->getId()) . "'");
            if ($cart_query->row['option']){
                $cart_options=$cart_query->row['option'];
                $cart_option=json_decode($cart_options,true);
                //232 is the option value for cycling payment
                $cycling= $cart_option[$option_id];
                switch ($cycling){
                case 31:
                case 33:
                case 47:
                case 55:
                  $months= 3;
                  break;
                case 32:
                case 34:
                case 48:
                case 56:
                  $months= 12;
                  break;
                default:
                  $months = 1;
                  break;
                }
                return $months;
            }

        }

        public function getProducts() {
           ]]></add>
       </operation>
       <operation info="Multiply total for thye selected monts inc cyclcing payment ">
           <search position="replace"><![CDATA[
              $product_data[] = array(
           ]]></search>
           <add><![CDATA[
              // Get the months
                 $months=$this->getCyclingMonths($cart['cart_id'], $cart['product_id']);

                $product_data[] = array(

           ]]></add>
       </operation>

       <operation info="Multiply total for thye selected monts inc cyclcing payment ">
           <search position="replace"><![CDATA[
            'total'           => ($price + $option_price) * $cart['quantity'],
           ]]></search>
           <add><![CDATA[
            'total'           => ($price + $option_price) * $cart['quantity'] * $months,
           ]]></add>
       </operation>

       <operation info="Multiply total for thye selected monts inc cyclcing payment ">
           <search position="replace"><![CDATA[
              $total += $this->tax->calculate($product['price'], $product['tax_class_id'], $this->config->get('config_tax')) * $product['quantity'];
           ]]></search>
           <add><![CDATA[
              $months=$this->getCyclingMonths($product['cart_id'], $cart['product_id']);
              $total += $this->tax->calculate($product['price'], $product['tax_class_id'], $this->config->get('config_tax')) * $product['quantity'] * $months;
           ]]></add>
       </operation>

   </file>
   <file name="catalog/controller/checkout/cart.php">
       <operation info="Add the function call into the file to get total paying months">
           <search position="replace"><![CDATA[
              $total = $this->currency->format($unit_price * $product['quantity'], $this->session->data['currency']);
           ]]></search>
           <add><![CDATA[
              $months= $this->cart->getCyclingMonths($product['cart_id'],$product['product_id']);
              $total = $this->currency->format($unit_price * $product['quantity'] * $months, $this->session->data['currency']);
           ]]></add>
       </operation>
   </file>
   <file name="catalog/controller/checkout/confirm.php">
       <operation info="Add the function call into the file to get total paying months">
           <search position="replace"><![CDATA[
                $data['products'][] = array(
           ]]></search>
           <add><![CDATA[
                $months= $this->cart->getCyclingMonths($product['cart_id'], $product['product_id']);

                $data['products'][] = array(
           ]]></add>
       </operation>
       <operation info="Multiply total for cycling months for the total">
           <search position="replace"><![CDATA[
                'total' => $this->currency->format($this->tax->calculate($product['price'], $product['tax_class_id'], $this->config->get('config_tax')) * $product['quantity'], $this->session->data['currency']),
           ]]></search>
           <add><![CDATA[
                'total'      => $this->currency->format($this->tax->calculate($product['price'], $product['tax_class_id'], $this->config->get('config_tax')) * $product['quantity'] * $months, $this->session->data['currency']),

           ]]></add>
       </operation>
      </file>
     <file name="catalog/controller/common/cart.php">
       <operation info="Multiply total for cycling months for the total">
           <search position="replace"><![CDATA[
            $total = $this->currency->format($unit_price * $product['quantity'], $this->session->data['currency']);
           ]]></search>
           <add><![CDATA[
            $months= $this->cart->getCyclingMonths($product['cart_id'], $product['product_id']);
            $total = $this->currency->format($unit_price * $product['quantity'] * $months, $this->session->data['currency']);
           ]]></add>
       </operation>

   </file>
     <file name="catalog/controller/extension/payment/pp_standard.php">
       <operation info="Multiply total for cycling months for the total">
           <search position="replace"><![CDATA[
              'price'    => $this->currency->format($product['price'], $order_info['currency_code'], false, false),
           ]]></search>
           <add><![CDATA[
              'price'    => $this->currency->format($product['total'], $order_info['currency_code'], false, false),
           ]]></add>
       </operation>

   </file>

</modification>
